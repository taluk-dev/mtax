<mat-card class="w-full">
    <div class="flex justify-between items-center p-4 border-b">
        <h2 class="text-xl font-bold m-0 text-slate-800">Gelir/Gider Kaynakları</h2>
        <button *ngIf="!isEditing()" mat-flat-button color="primary" (click)="startAdd()">
            <mat-icon>add</mat-icon> Yeni Ekle
        </button>
    </div>

    <mat-card-content class="p-6">
        <!-- Form Section -->
        <div *ngIf="isEditing()" class="mb-6 p-6 bg-slate-50 rounded-xl border border-slate-200">
            <h3 class="text-lg font-bold mb-4 text-slate-700">{{ currentSource().id ? 'Düzenle' : 'Yeni Ekle' }}</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <mat-form-field appearance="outline">
                    <mat-label>Kaynak Adı</mat-label>
                    <input matInput [(ngModel)]="currentSource().name">
                    <mat-icon matPrefix>label</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Mükellef</mat-label>
                    <mat-select [(ngModel)]="currentSource().taxpayer_id">
                        <mat-option *ngFor="let tp of taxpayers()" [value]="tp.id">{{ tp.full_name }}</mat-option>
                    </mat-select>
                    <mat-icon matPrefix>badge</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Tür</mat-label>
                    <mat-select [(ngModel)]="currentSource().type">
                        <mat-option [value]="1">Gelir</mat-option>
                        <mat-option [value]="-1">Gider</mat-option>
                        <mat-option [value]="0">Her İkisi</mat-option>
                    </mat-select>
                    <mat-icon matPrefix>tune</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Net/Brüt</mat-label>
                    <mat-select [(ngModel)]="currentSource().is_net">
                        <mat-option [value]="0">Brüt</mat-option>
                        <mat-option [value]="1">Net (Stopajlı)</mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Gider Türü</mat-label>
                    <mat-select [(ngModel)]="currentSource().deduction_type">
                        <mat-option [value]="0">Genel Gider (Safi İrat)</mat-option>
                        <mat-option [value]="1">Özel İndirim (Matrah)</mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Hisse Oranı (0-1.0)</mat-label>
                    <input matInput type="number" step="0.1" [(ngModel)]="currentSource().share_percentage">
                    <mat-icon matPrefix>percent</mat-icon>
                </mat-form-field>
            </div>

            <div class="flex justify-end gap-3 mt-4">
                <button mat-stroked-button (click)="cancelEdit()">İptal</button>
                <button mat-flat-button color="primary" (click)="save()">Kaydet</button>
            </div>
        </div>

        <!-- List Section -->
        <table mat-table [dataSource]="sources()" class="w-full">
            <!-- ID Column -->
            <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef class="w-16"> ID </th>
                <td mat-cell *matCellDef="let element" class="text-slate-500 font-mono text-xs"> #{{element.id}} </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef> Ad </th>
                <td mat-cell *matCellDef="let element" class="font-bold text-slate-700"> {{element.name}} </td>
            </ng-container>

            <!-- Taxpayer Column -->
            <ng-container matColumnDef="taxpayer">
                <th mat-header-cell *matHeaderCellDef> Mükellef </th>
                <td mat-cell *matCellDef="let element">
                    <span
                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                        {{ getTaxpayerName(element.taxpayer_id) }}
                    </span>
                </td>
            </ng-container>

            <!-- Type Column -->
            <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef> Tür </th>
                <td mat-cell *matCellDef="let element">
                    <span *ngIf="element.type === 1"
                        class="text-emerald-700 bg-emerald-100 px-2 py-1 rounded text-xs font-bold">GELİR</span>
                    <span *ngIf="element.type === -1"
                        class="text-rose-700 bg-rose-100 px-2 py-1 rounded text-xs font-bold">GİDER</span>
                    <span *ngIf="element.type === 0"
                        class="text-slate-700 bg-slate-100 px-2 py-1 rounded text-xs font-bold">HEPSİ</span>
                </td>
            </ng-container>

            <!-- Net/Brut Column -->
            <ng-container matColumnDef="is_net">
                <th mat-header-cell *matHeaderCellDef> Stopaj </th>
                <td mat-cell *matCellDef="let element">
                    <span *ngIf="element.is_net === 1" class="text-blue-600 font-bold text-xs">NET</span>
                    <span *ngIf="element.is_net === 0" class="text-slate-400 font-bold text-xs">BRÜT</span>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="text-right w-32"> İşlemler </th>
                <td mat-cell *matCellDef="let element" class="text-right">
                    <button mat-icon-button color="primary" (click)="startEdit(element)" matTooltip="Düzenle">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="delete(element.id)" matTooltip="Sil">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['id', 'name', 'taxpayer', 'type', 'is_net', 'actions']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['id', 'name', 'taxpayer', 'type', 'is_net', 'actions'];"
                class="hover:bg-slate-50"></tr>
            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell p-8 text-center text-slate-400" colspan="6">
                    <mat-icon class="text-4xl mb-2">inbox</mat-icon>
                    <div>Kayıt bulunamadı.</div>
                </td>
            </tr>
        </table>
    </mat-card-content>
</mat-card>