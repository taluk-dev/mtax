<mat-sidenav-container class="flex-1 bg-transparent h-full">
    <mat-sidenav-content class="dashboard-view">

        <div class="dashboard-grid">

            <!-- MAIN AREA -->
            <div class="main-area-col">

                <!-- DATA TABLE -->
                <mat-card class="main-data-card">
                    <div class="table-header-custom">
                        <div class="flex items-center gap-3">
                            <mat-icon class="text-indigo-600">view_list</mat-icon>
                            <h3 class="text-lg font-black text-slate-800">İşlem Hareketleri</h3>
                            <div class="flex items-center gap-1.5 ml-4">
                                <span
                                    class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider">{{filteredTransactions().length}}
                                    Kayıt</span>
                                <span
                                    class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider">
                                    Toplam: {{filteredTotalAmount() | number:'1.2-2'}} TL
                                </span>
                            </div>
                            <mat-icon class="text-indigo-600 cursor-pointer ml-3 hover:scale-110 transition-all"
                                routerLink="/transaction/new" matTooltip="Yeni İşlem">add_circle</mat-icon>
                        </div>
                    </div>

                    <div class="table-scroll-wrapper">
                        <table mat-table [dataSource]="filteredTransactions()" class="header-filters-table">
                            <!-- ID Column -->
                            <ng-container matColumnDef="id">
                                <th mat-header-cell *matHeaderCellDef class="!py-4">
                                    <div class="header-cell-content">
                                        <span
                                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ID</span>
                                    </div>
                                </th>
                                <td mat-cell *matCellDef="let tx" class="text-[10px] font-mono text-slate-400">
                                    #{{tx.id}}
                                </td>
                            </ng-container>

                            <!-- Combined Date Column -->
                            <ng-container matColumnDef="date">
                                <th mat-header-cell *matHeaderCellDef class="!py-4">
                                    <div class="header-cell-content">

                                        <div class="flex items-center gap-2">
                                            <!-- Month Filter -->
                                            <span [matMenuTriggerFor]="monthMenu"
                                                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest cursor-pointer hover:text-indigo-600 transition-all flex items-center gap-1">
                                                AY
                                                <mat-icon [class.!text-indigo-600]="isFilterActive('month')"
                                                    (click)="resetFilter('month', $event)"
                                                    class="!text-[12px] !w-[12px] !h-[12px]">{{isFilterActive('month')
                                                    ? 'filter_alt' : 'expand_more'}}</mat-icon>
                                            </span>
                                            <span class="text-[10px] text-slate-300 mx-1">/</span>
                                            <!-- Year Filter -->
                                            <span [matMenuTriggerFor]="yearMenu"
                                                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest cursor-pointer hover:text-indigo-600 transition-all flex items-center gap-1">
                                                YIL
                                                <mat-icon [class.!text-indigo-600]="isFilterActive('year')"
                                                    (click)="resetFilter('year', $event)"
                                                    class="!text-[12px] !w-[12px] !h-[12px]">{{isFilterActive('year')
                                                    ? 'filter_alt' : 'expand_more'}}</mat-icon>
                                            </span>

                                            <mat-menu #monthMenu="matMenu" class="compact-menu">
                                                <button mat-menu-item
                                                    (click)="updateFilter('month', 'all')">Tümü</button>
                                                <button mat-menu-item *ngFor="let m of months"
                                                    (click)="updateFilter('month', m.code)">{{m.name}}</button>
                                            </mat-menu>

                                            <mat-menu #yearMenu="matMenu" class="compact-menu">
                                                <button mat-menu-item
                                                    (click)="updateFilter('year', 'all')">Tümü</button>
                                                <button mat-menu-item *ngFor="let y of metadata().years"
                                                    (click)="updateFilter('year', y)">{{y}}</button>
                                            </mat-menu>
                                        </div>
                                    </div>
                                </th>
                                <td mat-cell *matCellDef="let tx" class="text-xs font-bold text-slate-600">
                                    <div class="flex flex-col">
                                        <span class="font-black text-indigo-600">{{tx.transaction_date |
                                            date:'dd.MM.yyyy'}}</span>
                                    </div>
                                </td>
                            </ng-container>

                            <!-- Taxpayer Column -->
                            <ng-container matColumnDef="taxpayer">
                                <th mat-header-cell *matHeaderCellDef class="!py-4">
                                    <div class="header-cell-content">
                                        <span [matMenuTriggerFor]="tpMenu"
                                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest cursor-pointer hover:text-indigo-600 transition-all flex items-center gap-1">
                                            MÜKELLEF
                                            <mat-icon [class.!text-indigo-600]="isFilterActive('taxpayer_id')"
                                                (click)="resetFilter('taxpayer_id', $event)"
                                                class="!text-[12px] !w-[12px] !h-[12px]">{{isFilterActive('taxpayer_id')
                                                ? 'filter_alt' : 'expand_more'}}</mat-icon>
                                        </span>
                                        <mat-menu #tpMenu="matMenu" class="compact-menu">
                                            <button mat-menu-item
                                                (click)="updateFilter('taxpayer_id', 'all')">Tümü</button>
                                            <button mat-menu-item *ngFor="let tp of metadata().taxpayers"
                                                (click)="updateFilter('taxpayer_id', tp.id)">
                                                {{tp.full_name}}
                                            </button>
                                        </mat-menu>
                                    </div>
                                </th>
                                <td mat-cell *matCellDef="let tx">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-black text-slate-700">{{tx.taxpayer_name}}</span>
                                    </div>
                                </td>
                            </ng-container>

                            <!-- Source Column -->
                            <ng-container matColumnDef="source">
                                <th mat-header-cell *matHeaderCellDef class="!py-4">
                                    <div class="header-cell-content">
                                        <span [matMenuTriggerFor]="sourceMenu"
                                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest cursor-pointer hover:text-indigo-600 transition-all flex items-center gap-1">
                                            KAYNAK
                                            <mat-icon [class.!text-indigo-600]="isFilterActive('source_id')"
                                                (click)="resetFilter('source_id', $event)"
                                                class="!text-[12px] !w-[12px] !h-[12px]">{{isFilterActive('source_id') ?
                                                'filter_alt' : 'expand_more'}}</mat-icon>
                                        </span>
                                        <mat-menu #sourceMenu="matMenu" class="compact-menu p-2">
                                            <div class="max-h-[300px] overflow-y-auto custom-scroll">
                                                <div *ngFor="let s of metadata().sources" class="px-3 py-1"
                                                    (click)="$event.stopPropagation()">
                                                    <mat-checkbox [checked]="filters().source_id.includes(s.id)"
                                                        (change)="toggleSourceFilter(s.id)"
                                                        class="text-[11px] font-bold text-slate-600">
                                                        {{s.name}}
                                                    </mat-checkbox>
                                                </div>
                                            </div>
                                        </mat-menu>
                                    </div>
                                </th>
                                <td mat-cell *matCellDef="let tx" class="text-[11px] font-bold text-slate-500">
                                    <span class="cursor-help border-b border-dotted border-slate-300 pb-0.5"
                                        [matTooltip]="tx.description" matTooltipPosition="above">
                                        {{tx.source_name}}
                                    </span>
                                </td>
                            </ng-container>

                            <!-- Type Column -->
                            <ng-container matColumnDef="type">
                                <th mat-header-cell *matHeaderCellDef class="!py-4">
                                    <div class="header-cell-content">
                                        <span [matMenuTriggerFor]="typeMenu"
                                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest cursor-pointer hover:text-indigo-600 transition-all flex items-center gap-1">
                                            TİP
                                            <mat-icon [class.!text-indigo-600]="isFilterActive('type')"
                                                (click)="resetFilter('type', $event)"
                                                class="!text-[12px] !w-[12px] !h-[12px]">{{isFilterActive('type') ?
                                                'filter_alt' : 'expand_more'}}</mat-icon>
                                        </span>
                                        <mat-menu #typeMenu="matMenu" class="compact-menu">
                                            <button mat-menu-item (click)="updateFilter('type', 'all')">Tümü</button>
                                            <button mat-menu-item (click)="updateFilter('type', 1)">Gelir</button>
                                            <button mat-menu-item (click)="updateFilter('type', -1)">Gider</button>
                                        </mat-menu>
                                    </div>
                                </th>
                                <td mat-cell *matCellDef="let tx">
                                    <div [class]="tx.type === 1 ? 'status-badge income' : 'status-badge expense'">
                                        {{tx.type === 1 ? 'Gelir' : 'Gider'}}
                                    </div>
                                </td>
                            </ng-container>

                            <!-- Taxable Column -->
                            <ng-container matColumnDef="is_taxable">
                                <th mat-header-cell *matHeaderCellDef class="!py-4">
                                    <div class="header-cell-content">
                                        <span [matMenuTriggerFor]="taxMenu"
                                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest cursor-pointer hover:text-indigo-600 transition-all flex items-center gap-1">
                                            BEYAN
                                            <mat-icon [class.!text-indigo-600]="isFilterActive('is_taxable')"
                                                (click)="resetFilter('is_taxable', $event)"
                                                class="!text-[12px] !w-[12px] !h-[12px]">{{isFilterActive('is_taxable')
                                                ? 'filter_alt' : 'expand_more'}}</mat-icon>
                                        </span>
                                        <mat-menu #taxMenu="matMenu" class="compact-menu">
                                            <button mat-menu-item
                                                (click)="updateFilter('is_taxable', 'all')">Tümü</button>
                                            <button mat-menu-item
                                                (click)="updateFilter('is_taxable', true)">Evet</button>
                                            <button mat-menu-item
                                                (click)="updateFilter('is_taxable', false)">Hayır</button>
                                        </mat-menu>
                                    </div>
                                </th>
                                <td mat-cell *matCellDef="let tx" class="text-center">
                                    <mat-icon
                                        [class]="tx.is_taxable ? 'tax-indicator active' : 'tax-indicator inactive'">
                                        {{tx.is_taxable ? 'verified' : 'horizontal_rule'}}
                                    </mat-icon>
                                </td>
                            </ng-container>

                            <!-- Amount Column -->
                            <ng-container matColumnDef="amount">
                                <th mat-header-cell *matHeaderCellDef class="text-right">
                                    <div class="header-cell-content items-center">
                                        <span
                                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">TUTAR</span>

                                    </div>
                                </th>
                                <td mat-cell *matCellDef="let tx" class="text-right">
                                    <span [ngClass]="tx.type === 1 ? 'text-emerald-600' : 'text-rose-600'"
                                        class="text-sm font-black tracking-tighter">
                                        {{ (tx.type === 1 ? tx.amount : -tx.amount) | number:'1.2-2' }} <small
                                            class="text-[9px] opacity-60 ml-0.5">TL</small>
                                    </span>
                                </td>
                            </ng-container>

                            <!-- Actions Column -->
                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef class="text-center">
                                    <div class="header-cell-content items-center">
                                        <span
                                            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">İŞLEM</span>
                                    </div>
                                </th>
                                <td mat-cell *matCellDef="let tx" class="text-center">
                                    <button mat-icon-button [matMenuTriggerFor]="menu" class="text-slate-400">
                                        <mat-icon>more_vert</mat-icon>
                                    </button>
                                    <mat-menu #menu="matMenu" class="!rounded-2xl !p-2 !shadow-2xl">
                                        <button mat-menu-item (click)="duplicateTx(tx)"
                                            class="!text-slate-600 !font-bold">
                                            <mat-icon class="!text-indigo-600">content_copy</mat-icon> Kopyala
                                        </button>
                                        <button mat-menu-item (click)="openEdit(tx)" class="!text-slate-600 !font-bold">
                                            <mat-icon class="!text-amber-500">edit_note</mat-icon> Düzenle
                                        </button>
                                        <mat-divider class="!my-2"></mat-divider>
                                        <button mat-menu-item (click)="deleteTx(tx.id)"
                                            class="!text-rose-600 !font-bold">
                                            <mat-icon class="!text-rose-600">delete_sweep</mat-icon> Sil
                                        </button>
                                    </mat-menu>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="!h-24"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                                class="hover:bg-slate-50/50 transition-all border-b border-slate-50"></tr>
                        </table>

                        <div *ngIf="filteredTransactions().length === 0"
                            class="flex flex-col items-center justify-center p-24 text-slate-300">
                            <mat-icon class="!w-24 !h-24 !text-9xl mb-6 opacity-30">inventory_2</mat-icon>
                            <p class="font-black uppercase tracking-[0.3em] text-xs">Aradığınız kriterlere uygun kayıt
                                bulunanamadı</p>
                        </div>
                    </div>
                </mat-card>

            </div>
        </div>
    </mat-sidenav-content>

</mat-sidenav-container>