<div class="p-8 mx-auto w-full" style="max-width: 800px;">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold m-0">
                {{isEdit ? 'Kayıt Düzenle' : (isDuplicate ? 'Kopyadan Yeni Kayıt' : 'Yeni Kayıt Oluştur')}}
            </h1>
        </div>
        <button mat-icon-button (click)="cancel()" matTooltip="İptal ve Geri Dön">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <mat-card>
        <mat-card-content class="p-6">
            <div class="grid grid-cols-2 gap-6">

                <!-- Üst Satır: Net Tutar (Sol) ve Tarih (Sağ) -->
                <div class="col-span-2 flex gap-6">
                    <!-- Net Tutar -->
                    <div class="w-1/2">
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Net Tutar TL</mat-label>
                            <input matInput type="text" [ngModel]="amountProxy" (ngModelChange)="updateAmount($event)"
                                (blur)="formatAmountOnBlur()" [errorStateMatcher]="amountMatcher" placeholder="0,00">
                            <mat-icon matPrefix>payments</mat-icon>
                            <mat-error *ngIf="amountError()">{{amountError()}}</mat-error>
                        </mat-form-field>
                    </div>

                    <!-- Tarih (Gün, Ay, Yıl) -->
                    <div class="w-1/2 flex gap-2">
                        <mat-form-field appearance="outline" class="w-1/3">
                            <mat-label>Gün</mat-label>
                            <input matInput type="number" [(ngModel)]="formTx.day" min="1" max="31">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="w-1/3">
                            <mat-label>Ay</mat-label>
                            <input matInput type="number" [(ngModel)]="formTx.month" min="1" max="12">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="w-1/3">
                            <mat-label>Yıl</mat-label>
                            <input matInput type="number" [(ngModel)]="formTx.year">
                        </mat-form-field>
                    </div>
                </div>

                <!-- Mükellef -->
                <div class="col-span-1">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Mükellef</mat-label>
                        <mat-select [(ngModel)]="formTx.taxpayer_id">
                            <mat-option *ngFor="let tp of metadata().taxpayers" [value]="tp.id">
                                {{tp.full_name}}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>badge</mat-icon>
                    </mat-form-field>
                </div>

                <!-- İşlem Türü -->
                <div class="col-span-1">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>İşlem Türü</mat-label>
                        <mat-select [(ngModel)]="formTx.type">
                            <mat-option [value]="1">GELİR</mat-option>
                            <mat-option [value]="-1">GİDER</mat-option>
                        </mat-select>
                        <mat-icon matPrefix>tune</mat-icon>
                    </mat-form-field>
                </div>

                <!-- Kaynak / Hesap -->
                <div class="col-span-1">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Kaynak / Hesap</mat-label>
                        <mat-select [(ngModel)]="formTx.source_id">
                            <mat-option *ngFor="let s of filteredFormSources()" [value]="s.id">
                                {{s.name}}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>account_balance</mat-icon>
                    </mat-form-field>
                </div>

                <!-- Ödeme Tipi -->
                <div class="col-span-1">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Ödeme Tipi</mat-label>
                        <mat-select [(ngModel)]="formTx.payment_method_id">
                            <mat-option *ngFor="let p of metadata().payment_methods" [value]="p.id">
                                {{p.method_name}}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>credit_card</mat-icon>
                    </mat-form-field>
                </div>

                <!-- Açıklama -->
                <div class="col-span-2">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>İşlem Açıklaması</mat-label>
                        <textarea matInput [(ngModel)]="formTx.description" rows="2"></textarea>
                        <mat-icon matPrefix>segment</mat-icon>
                    </mat-form-field>
                </div>

                <!-- Referans Bilgileri: Vergi Kodu ve GDrive -->
                <div class="col-span-1">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Vergi Kalem Kodu</mat-label>
                        <input matInput [(ngModel)]="formTx.tax_item_code" maxlength="10">
                        <mat-icon matPrefix>code</mat-icon>
                    </mat-form-field>
                </div>

                <div class="col-span-1">
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Google Drive Dosyası (ID)</mat-label>
                        <input matInput [(ngModel)]="formTx.gdrive_id" placeholder="ID veya Link">
                        <mat-icon matPrefix>cloud</mat-icon>
                    </mat-form-field>
                </div>
                <!-- Alt İşlemler: Checkbox solda, Butonlar sağda -->
                <div class="col-span-2 flex items-center justify-between mt-4">
                    <mat-checkbox [(ngModel)]="formTx.is_taxable" color="primary">
                        Resmi Beyana Dahil Et
                    </mat-checkbox>
                    <div class="flex gap-3">
                        <button mat-button (click)="cancel()">VAZGEÇ</button>
                        <button mat-flat-button color="primary" (click)="save()"
                            [disabled]="loading() || !!amountError()">
                            {{loading() ? 'İŞLENİYOR...' : 'KAYDET'}}
                        </button>
                    </div>
                </div>

            </div>
        </mat-card-content>
    </mat-card>
</div>